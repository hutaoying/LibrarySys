package com.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.actionForm.ManagerForm;
import com.actionForm.ReaderForm;
import org.apache.struts.action.*;

import com.dao.ReaderDAO;

import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;

public class Reader extends Action {
    private ReaderDAO readerDAO = null;
    public Reader() {
        this.readerDAO = new ReaderDAO();
    }

    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                 HttpServletRequest request,
                                 HttpServletResponse response) {
        String action =request.getParameter("action");
        System.out.println("\nreader*********************action="+action);
        if(action==null||"".equals(action)){
            request.setAttribute("error","您的操作有误！");
            return mapping.findForward("error");
        }else if("login_reader".equals(action)){
        	return readerlogin(mapping,form,request,response);
        }
        else if("readerAdd".equals(action)){
            return readerAdd(mapping,form,request,response);
        }else if("readerQuery".equals(action)){
            return readerQuery(mapping,form,request,response);
        }else if("readerModifyQuery".equals(action)){
            return readerModifyQuery(mapping,form,request,response);
        }else if("readerModify".equals(action)){
            return readerModify(mapping,form,request,response);
        }else if("readerDel".equals(action)){
            return readerDel(mapping,form,request,response);
        }else if("readerDetail".equals(action)){
            return readerDetail(mapping,form,request,response);
        }else if("querypwd".equals(action)){
        	return queryQwd(mapping,form,request,response);
        }else if ("modifypwd".equals(action)) {
			return modifypwd(mapping, form, request, response);
		}
        request.setAttribute("error","操作失败！");
        return mapping.findForward("error");
    }
    //修改用户密码
    private ActionForward modifypwd(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
    	ReaderForm readerForm = (ReaderForm) form;
    	readerForm.setName(readerForm.getName());
    	readerForm.setPassword(readerForm.getPassword());
		int ret = readerDAO.updatePwd(readerForm);
		if (ret == 0) {
			request.setAttribute("error", "更改口令失败！");
			return mapping.findForward("error");
		} else {
			return mapping.findForward("pwdModify");
		}
	}

	//修改密码时查询
        private ActionForward queryQwd(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
        	
        	ReaderForm readerForm = (ReaderForm) form;
    		HttpSession session = request.getSession();
    		String user_name = (String) session.getAttribute("user");
    		readerForm.setName(user_name);
    		System.out.print("查询到的user:" + user_name);
    		request.setAttribute("pwdQueryif", readerDAO.query_pwd(readerForm));
    		return mapping.findForward("pwdQueryModify");
    		
	}

	// 读者身份验证
    private ActionForward readerlogin(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		// TODO Auto-generated method stub
    	ReaderForm readerForm=(ReaderForm) form;
    	readerForm.setName(readerForm.getName());
    	readerForm.setPassword(readerForm.getPassword());
    	readerForm=readerDAO.checkReader(readerForm);
    	//int ret=readerDAO.checkReader(readerForm);
    	if (readerForm!=null) {
			HttpSession session = request.getSession();
			session.setAttribute("user", readerForm.getName());
			session.setAttribute("user_id",readerForm.getId());
			return mapping.findForward("readerLoginok");
		} else {
			request.setAttribute("error", "您输入的用户账号或密码错误！");
			return mapping.findForward("error");
		}
   
  
	}

	/***********************添加读者信息**************************/
    private ActionForward readerAdd(ActionMapping mapping, ActionForm form,
                           HttpServletRequest request,
                           HttpServletResponse response){
           ReaderForm readerForm = (ReaderForm) form;
           readerForm.setName(readerForm.getName());
           readerForm.setSex(readerForm.getSex());
           readerForm.setNumid(readerForm.getNumid());
           readerForm.setVocation(readerForm.getVocation());
           readerForm.setBirthday(readerForm.getBirthday());
           readerForm.setPaperType(readerForm.getPaperType());
           readerForm.setPaperNO(readerForm.getPaperNO());
           readerForm.setTel(readerForm.getTel());
           readerForm.setEmail(readerForm.getEmail());
           //获取系统日期
           Date date1=new Date();
           java.sql.Date date=new java.sql.Date(date1.getTime());
           System.out.println(date);
           readerForm.setCreateDate(date);
           readerForm.setOperator(readerForm.getOperator());
           readerForm.setRemark(readerForm.getRemark());
           readerForm.setTypeid(readerForm.getTypeid());
           int a=readerDAO.insert(readerForm);
           if(a==0){
               request.setAttribute("error","读者信息添加失败！");
               return mapping.findForward("error");
         }else if(a==2){
             request.setAttribute("error","该读者信息已经添加！");
             return mapping.findForward("error");
         }else{
             return mapping.findForward("readerAdd");
        }
       }
       /***********************查询全部读者信息**************************/
       private ActionForward readerQuery(ActionMapping mapping, ActionForm form,
                              HttpServletRequest request,
                              HttpServletResponse response){
       String str=null;
       request.setAttribute("reader",readerDAO.query(str));
       ArrayList coll=(ArrayList) request.getAttribute("reader");
       System.out.println(coll+"================");
       return mapping.findForward("readerQuery");
       }
        /***********************查询修改读者信息**************************/
        private ActionForward readerModifyQuery(ActionMapping mapping, ActionForm form,
                              HttpServletRequest request,
                              HttpServletResponse response){
            ReaderForm readerForm=(ReaderForm)form;
            System.out.println("查询修改读者信息："+request.getParameter("ID"));
            readerForm.setId(Integer.valueOf(request.getParameter("ID")));
            request.setAttribute("readerQueryif",readerDAO.queryM(readerForm));
            return mapping.findForward("readerQueryModify");
        }
        /***********************查询读者详细信息**************************/
        private ActionForward readerDetail(ActionMapping mapping, ActionForm form,
                              HttpServletRequest request,
                              HttpServletResponse response){
            ReaderForm readerForm=(ReaderForm)form;
            String d=request.getParameter("ID");
            
            readerForm.setId(Integer.valueOf(request.getParameter("ID")));
            request.setAttribute("readerDetail",readerDAO.queryM(readerForm));
            return mapping.findForward("readerDeatil");
        }
        /***********************修改读者信息**************************/
        private ActionForward readerModify(ActionMapping mapping, ActionForm form,
                              HttpServletRequest request,
                              HttpServletResponse response){
            ReaderForm readerForm=(ReaderForm)form;
            readerForm.setName(readerForm.getName());
            readerForm.setSex(readerForm.getSex());
            readerForm.setNumid(readerForm.getNumid());
            readerForm.setVocation(readerForm.getVocation());
            readerForm.setBirthday(readerForm.getBirthday());
            readerForm.setPaperType(readerForm.getPaperType());
            readerForm.setPaperNO(readerForm.getPaperNO());
            readerForm.setTel(readerForm.getTel());
            readerForm.setEmail(readerForm.getEmail());
            readerForm.setOperator(readerForm.getOperator());
            readerForm.setRemark(readerForm.getRemark());
            readerForm.setTypeid(readerForm.getTypeid());
            int ret=readerDAO.update(readerForm);
            if(ret==0){
                request.setAttribute("error","修改读者信息失败！");
                return mapping.findForward("error");
            }else{
                return mapping.findForward("readerModify");
            }
        }
        /***********************删除读者信息**************************/
        private ActionForward readerDel(ActionMapping mapping, ActionForm form,
                              HttpServletRequest request,
                              HttpServletResponse response){
            ReaderForm readerForm=(ReaderForm)form;
            readerForm.setId(Integer.valueOf(request.getParameter("ID")));
            int ret=readerDAO.delete(readerForm);
            if(ret==0){
                request.setAttribute("error","删除读者信息失败！");
                return mapping.findForward("error");
            }else{
                return mapping.findForward("readerDel");
            }
        }
}
